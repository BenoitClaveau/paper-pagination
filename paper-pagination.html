<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../neon-animation/web-animations.html">

<dom-module id="paper-pagination">
    <style>
        :host [hidden] {
            display: none;
        }
        :host [pointer] {
            cursor: pointer;
        }
    </style>
    <template>
        <div hidden$="[[hiddenPagination(pages)]]" class="paper-pagination-container" style="display:flex;flex-direction:row;justify-content:center;align-items: center;">
            <paper-icon-button id="prev" on-tap="prev" icon="chevron-left"></paper-icon-button>
            <paper-listbox id="pages" selected="{{current}}" selected-attribute="page" style="display:flex;flex-direction:row;justify-content:center;align-items: center;">
                <template is="dom-repeat" items="[[pages]]">
                    <paper-item class="paper-pagination" hidden$="[[item.hidden]]" page="[[item.page]]" pointer>[[item.label]]</paper-item>
                </template>
            </paper-listbox>
            <paper-icon-button id="next" on-tap="next" icon="chevron-right"></paper-icon-button>
        </div>
    </template>
    <script>
        Polymer({
            is: 'paper-pagination',

            behaviors: [
                Polymer.IronResizableBehavior
            ],

            listeners: {
                'iron-resize': 'onResize'
            },

            attached: function() {
                this.async(this.notifyResize, 1);
            },

            properties: {
                pageSize: Number,
                pageCount: Number,
                total:  Number,
                pages: {
                    type: Array,
                    value: []
                },
                rangeSize: {
                    type: Number,
                    value: 10
                },
                current: {
                    type: Number,
                    reflectToAttribute: true,
                    notify: true,
                },
                hidden: {
                    type: Boolean,
                    notify: true
                }
            },
            observers: [
            'currentChanged(current)',
            'rangeSizeChanged(rangeSize)',
            'pagesChanged(pageSize, total)'
            ],

            ready:function(){
                this.itemWidth = 50;
                this.prevWidth = this.nextWidth = 40;
            },
            
            prev: function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.set("current", Math.max(this.current - 1, 0));
            },

            next: function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.set("current", Math.max(this.current + 1, this.pageCount - 1));
            },

            hiddenPagination: function(pages) {
                this.set("hidden", pages.length <= 1);
                return this.hidden;
            },

            pagesChanged: function(size, total) {
                this.set("pageCount", Math.ceil(total / size));
                var result = [];
                for (var i = 0; i < this.pageCount; i++) {
                    result.push({
                        page: i,
                        label: i + 1,
                        hidden: true
                    });
                }
                
                this.set("pages", result);
                this.currentChanged(this.current);
            },

            currentChanged: function(current) {
                this.$.prev.disabled = current == 0;
                this.$.next.disabled = current == this.pageCount - 1;

                var rangeSizeIndex = this.rangeSize - 1;
                var start = 0;
                var end = Math.min(rangeSizeIndex, this.pageCount);
                var mid = Math.floor(rangeSizeIndex / 2);

                if (current > mid ) {
                    start = current - mid;
                    end = start + rangeSizeIndex;
                }

                if (current > this.pageCount - mid - 1 ) {
                    end = this.pageCount - 1;
                    start = end - rangeSizeIndex;
                }

                for (var i = 0; i < this.pages.length; i++) {    
                    this.set("pages." + i + ".hidden", i < start || i > end);
                }

                var myEffect = new KeyframeEffect(document.body, [], { duration: 350, easing: "ease-out" }); 
                var scrollTop = document.body.scrollTop;

                myEffect.onsample = function(timeFraction, effect, animation) {
                    timeFraction = timeFraction == null ? 1 : timeFraction;
                    effect.target.scrollTop = scrollTop - (scrollTop * timeFraction); 
                }; 
                var myAnimation = document.timeline.play(myEffect);
            },

            rangeSizeChanged: function(rangeSize) {
                this.currentChanged(this.current);
            },

            onResize: function() {
                var container = this.shadowRoot.querySelector(".paper-pagination-container")
                var rect = container.getBoundingClientRect();
                if (rect.top == 0 && rect.bottom == 0) return;
                var width = rect.right - rect.left;
                var height = rect.top - rect.bottom;
                visible = this.pages.filter(function(item) {
                    return !item.hidden;
                }).length;

                var items = Math.floor((width - 40 - (this.prevWidth + this.nextWidth)) / this.itemWidth); //40 for bonus space
                
                if (visible > items) {
                    this.previousRangeSize = this.rangeSize;
                    this.rangeSize = items;
                }
                else if(this.previousRangeSize && visible < items) {
                    var previousRangeSize = this.previousRangeSize;
                    delete this.previousRangeSize;
                    this.rangeSize = previousRangeSize;
                }
            }
        })
    </script>
</dom-module>
